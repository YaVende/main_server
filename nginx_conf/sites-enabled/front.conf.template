server {
  server_name ${FRONT_DOMAIN} www.${FRONT_DOMAIN};
  root ${FRONT_ASSETS_PATH};

  include '/etc/nginx/snippets/acme_challenge.conf';
  include '/etc/nginx/snippets/appcache.conf';

  location / {
    return 301 https://${FRONT_DOMAIN}$request_uri;
  }
}

server {
  server_name www.${FRONT_DOMAIN};
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  return 301 https://${FRONT_DOMAIN}$request_uri;
}

server {
  server_name ${FRONT_DOMAIN};
  root ${FRONT_ASSETS_PATH};

  include '/etc/nginx/snippets/https.conf';
  include '/etc/nginx/snippets/gzip.conf';
  include '/etc/nginx/snippets/appcache.conf';

  location / {
    autoindex on;
    try_files $uri @prerender;
  }

  location @prerender {
    set $prerender 0;

    if ($http_user_agent ~* "googlebot|yahoo|bingbot|baiduspider|yandex|yeti|yodaobot|gigabot|ia_archiver|facebookexternalhit|twitterbot|developers\.google\.com") {
      set $prerender 1;
    }

    if ($args ~ "_escaped_fragment_|prerender=1") { set $prerender 1; }
    if ($http_user_agent ~ "Prerender") { set $prerender 0; }

    if ($prerender = 1) {
      rewrite .* /$scheme://$host$request_uri? break;
      proxy_pass ${PRERENDER_HOST};
    }

    if ($prerender = 0) { rewrite .* /index.html break; }
  }
}
